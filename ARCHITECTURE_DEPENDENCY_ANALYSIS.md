# Architecture Dependency & Flow Analysis

## üîç Current Dependency Graph

```
main.go
‚îÇ
‚îú‚îÄ Repositories (Data Access Layer)
‚îÇ  ‚îú‚îÄ unitRepo (UnitRepository)
‚îÇ  ‚îú‚îÄ tenantRepo (TenantRepository)
‚îÇ  ‚îú‚îÄ paymentRepo (PaymentRepository)
‚îÇ  ‚îú‚îÄ userRepo (UserRepository)
‚îÇ  ‚îî‚îÄ sessionRepo (SessionRepository)
‚îÇ
‚îú‚îÄ Services (Business Logic Layer)
‚îÇ  ‚îú‚îÄ unitService (UnitService)
‚îÇ  ‚îÇ  ‚îî‚îÄ Depends on: unitRepo
‚îÇ  ‚îÇ
‚îÇ  ‚îú‚îÄ tenantService (TenantService) ‚ö†Ô∏è
‚îÇ  ‚îÇ  ‚îî‚îÄ Depends on: tenantRepo, unitRepo, paymentRepo (DIRECT - ISSUE)
‚îÇ  ‚îÇ
‚îÇ  ‚îú‚îÄ paymentService (PaymentService) ‚ö†Ô∏è
‚îÇ  ‚îÇ  ‚îî‚îÄ Depends on: paymentRepo, tenantRepo, unitRepo
‚îÇ  ‚îÇ     ‚îî‚îÄ Uses tenantRepo/unitRepo to fetch rent info when creating payments
‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ authService (AuthService)
‚îÇ     ‚îî‚îÄ Depends on: userRepo, sessionRepo
‚îÇ
‚îî‚îÄ Handlers (Presentation Layer)
   ‚îú‚îÄ rentalHandler (RentalHandler)
   ‚îÇ  ‚îî‚îÄ Depends on: unitService, tenantService, paymentService, authService
   ‚îÇ
   ‚îú‚îÄ tenantHandler (TenantHandler)
   ‚îÇ  ‚îî‚îÄ Depends on: tenantService, paymentService, userRepo, authService
   ‚îÇ
   ‚îî‚îÄ authHandler (AuthHandler)
      ‚îî‚îÄ Depends on: authService
```

---

## üìä Service Method Usage Analysis

### PaymentService (414 lines) - Current Responsibilities

| Method | Uses tenantRepo? | Uses unitRepo? | Purpose |
|--------|-----------------|----------------|---------|
| `CreateMonthlyPayment` | ‚úÖ Yes (line 29) | ‚úÖ Yes (line 34) | Gets tenant ‚Üí unit ‚Üí MonthlyRent for payment amount |
| `MarkPaymentAsPaid` | ‚ùå No | ‚ùå No | Updates payment status |
| `GetPaymentByID` | ‚úÖ Yes (line 104) | ‚úÖ Yes (line 111) | Loads tenant/unit for display |
| `GetPaymentsByTenantID` | ‚ùå No | ‚ùå No | Direct repo call |
| `GetOverduePayments` | ‚ùå No | ‚ùå No | Filters payments by status |
| `GetPendingPayments` | ‚ùå No | ‚ùå No | Filters payments by status |
| `GetPaymentSummary` | ‚ùå No | ‚ùå No | Aggregates payment data |
| `GetAllPayments` | ‚ùå No | ‚ùå No | Direct repo call |
| `GetPendingVerifications` | ‚ùå No | ‚ùå No | Direct repo call |
| `SubmitPaymentIntent` | ‚úÖ Yes (indirect via getOrCreateCurrentPayment) | ‚úÖ Yes (indirect) | Gets/creates payment, needs unit info |
| `VerifyTransaction` | ‚ùå No | ‚ùå No | ‚ö†Ô∏è INEFFICIENT: Loops all payments to find transaction |
| `getOrCreateCurrentPayment` | ‚úÖ Yes (line 332) | ‚úÖ Yes (line 337) | Gets tenant ‚Üí unit ‚Üí MonthlyRent |
| `CreateNextPayment` | ‚ùå No | ‚ùå No | Uses existing payment data |
| `autoCreateNextPayment` | ‚ùå No | ‚ùå No | Checks/creates next payment |

**PaymentService Dependencies Analysis:**
- **tenantRepo/unitRepo usage**: Necessary - PaymentService needs to know rent amount when creating payments
- **Reason**: Payment amount comes from `unit.MonthlyRent`, not from tenant
- **Pattern**: `tenantID ‚Üí tenant ‚Üí unitID ‚Üí unit ‚Üí MonthlyRent`

---

### TenantService (237 lines) - Current Responsibilities

| Method | Uses paymentRepo? | Should Use PaymentService? |
|--------|-------------------|----------------------------|
| `CreateTenant` | ‚úÖ Yes (via createFirstPayment) | ‚úÖ YES - Should use PaymentService |
| `createFirstPayment` | ‚úÖ Yes (line 96) | ‚úÖ YES - Duplicates payment creation logic |
| `MoveOutTenant` | ‚úÖ Yes (lines 160, 167) | ‚úÖ YES - Should use PaymentService |
| `GetTenantByID` | ‚ùå No | ‚ùå No |
| `GetAllTenants` | ‚ùå No | ‚ùå No |
| Others | ‚ùå No | ‚ùå No |

**TenantService Issues:**
1. **Direct paymentRepo usage** - Bypasses PaymentService business logic
2. **Duplicated payment creation logic** - `createFirstPayment` duplicates `getOrCreateCurrentPayment`
3. **Inconsistent** - Should use PaymentService like handlers do

---

### Handler Usage Analysis

#### RentalHandler Methods:

| Handler Method | Services Called | Payment Methods Used |
|----------------|----------------|----------------------|
| `Dashboard` | unitService, tenantService, paymentService | GetAllPayments, GetPaymentSummary |
| `GetUnits` | unitService | - |
| `GetTenants` | tenantService | - |
| `CreateTenant` | tenantService | (indirect - creates payment) |
| `GetPayments` | paymentService | GetAllPayments |
| `MarkPaymentAsPaid` | paymentService | VerifyTransaction, MarkPaymentAsPaid |
| `VacateTenant` | tenantService | (indirect - deletes payments) |
| `GetSummary` | unitService, paymentService | GetPaymentSummary |
| `UnitDetails` | unitService, tenantService, paymentService | GetPaymentsByTenantID, GetPendingVerifications |
| `GetPendingVerifications` | paymentService | GetPendingVerifications |

#### TenantHandler Methods:

| Handler Method | Services Called | Payment Methods Used |
|----------------|----------------|----------------------|
| `Me` | tenantService, paymentService | GetPaymentsByTenantID |
| `SubmitPayment` | paymentService | SubmitPaymentIntent |
| `ChangePassword` | authService, userRepo | - |

---

## üîÑ Code Flow Examples

### Flow 1: Tenant Submits Transaction ID

```
TenantHandler.SubmitPayment()
  ‚Üì
paymentService.SubmitPaymentIntent(tenantID, txnID)
  ‚Üì
paymentService.getOrCreateCurrentPayment(tenantID)
  ‚îÇ
  ‚îú‚îÄ> paymentRepo.GetUnpaidPaymentsByTenantID(tenantID)
  ‚îÇ   ‚îî‚îÄ> If found: return unpaid[0]
  ‚îÇ
  ‚îî‚îÄ> If not found:
      ‚îú‚îÄ> tenantRepo.GetTenantByID(tenantID)  ‚Üê NEEDS tenantRepo
      ‚îú‚îÄ> unitRepo.GetUnitByID(tenant.UnitID)  ‚Üê NEEDS unitRepo
      ‚îî‚îÄ> paymentRepo.CreatePayment()  ‚Üê Creates with MonthlyRent
  ‚Üì
paymentRepo.GetTransactionByPaymentAndID(paymentID, txnID)
  ‚Üì
paymentRepo.CreatePaymentTransaction(tx)
```

**Why tenantRepo/unitRepo needed?**
- PaymentService doesn't know the rent amount
- Must fetch: tenant ‚Üí unit ‚Üí MonthlyRent

---

### Flow 2: Owner Verifies Transaction

```
RentalHandler.MarkPaymentAsPaid()
  ‚Üì
paymentService.VerifyTransaction(transactionID, amount, userID)
  ‚Üì
‚ö†Ô∏è INEFFICIENT LOOP (lines 281-293):
  ‚îú‚îÄ> paymentRepo.GetAllPayments()  ‚Üê Gets ALL payments
  ‚îú‚îÄ> For each payment:
  ‚îÇ   ‚îî‚îÄ> paymentRepo.GetPaymentTransactionsByPaymentID(payment.ID)
  ‚îÇ       ‚îî‚îÄ> Check if transactionID matches
  ‚îî‚îÄ> If found: paymentID = p.ID
  ‚Üì
paymentRepo.VerifyTransaction(transactionID, amount, userID)
  ‚îÇ   ‚îî‚îÄ> Updates transaction + payment in DB transaction
  ‚Üì
paymentRepo.GetPaymentByID(paymentID)
  ‚Üì
If IsFullyPaid:
  ‚îî‚îÄ> paymentService.autoCreateNextPayment(payment)
      ‚îî‚îÄ> paymentService.CreateNextPayment(payment)
```

**Issue:** VerifyTransaction loops through ALL payments to find one transaction!

---

### Flow 3: Create Tenant (with first payment)

```
RentalHandler.CreateTenant()
  ‚Üì
tenantService.CreateTenant(tenant)
  ‚îÇ
  ‚îú‚îÄ> tenantRepo.CreateTenant()
  ‚îú‚îÄ> unitRepo.UpdateUnitOccupancy()
  ‚îî‚îÄ> tenantService.createFirstPayment(tenant)  ‚Üê DIRECT paymentRepo usage
      ‚îÇ
      ‚îú‚îÄ> unitRepo.GetUnitByID()  ‚Üê Gets unit info
      ‚îú‚îÄ> Calculate due date
      ‚îî‚îÄ> paymentRepo.CreatePayment()  ‚ö†Ô∏è BYPASSES PaymentService
```

**Issue:** TenantService directly uses paymentRepo instead of PaymentService

---

## ‚ö†Ô∏è Identified Issues

### Issue 1: TenantService Bypasses PaymentService
**Location:** `tenant_service.go:96`, `tenant_service.go:160, 167`
- `createFirstPayment()` uses `paymentRepo.CreatePayment()` directly
- `MoveOutTenant()` uses `paymentRepo` methods directly
- Should use PaymentService to ensure business logic consistency

**Impact:** 
- Payment creation logic duplicated
- Changes to payment creation must be made in 2 places
- Potential inconsistency

---

### Issue 2: VerifyTransaction Inefficient Query
**Location:** `payment_service.go:275-315`
- Loops through ALL payments to find transaction
- Should query transaction first to get payment_id directly

**Current (Inefficient):**
```go
payments, _ := s.paymentRepo.GetAllPayments()
for _, p := range payments {
    txs, _ := s.paymentRepo.GetPaymentTransactionsByPaymentID(p.ID)
    for _, tx := range txs {
        if tx.TransactionID == transactionID {
            paymentID = p.ID
        }
    }
}
```

**Should be:**
```go
// Query transaction first to get payment_id
tx, err := s.paymentRepo.GetTransactionByID(transactionID)
if err != nil || tx == nil {
    return fmt.Errorf("transaction not found")
}
paymentID = tx.PaymentID
```

**Impact:** Performance issue - O(n) where n = total payments

---

### Issue 3: PaymentService Size (414 lines)
**Responsibilities:**
1. Payment CRUD operations ‚úÖ
2. Payment queries ‚úÖ
3. Status calculations (overdue, pending, summary) ‚úÖ
4. Transaction submission/verification ‚úÖ
5. Payment lifecycle (auto-create next) ‚úÖ
6. Helper methods (getOrCreateCurrentPayment) ‚úÖ

**Analysis:**
- Methods are logically related (all payment-related)
- Dependencies make sense (needs tenant/unit info for rent)
- BUT: Could be split for better separation

---

### Issue 4: Duplicated Payment Creation Logic
**Location:** 
- `TenantService.createFirstPayment()` (lines 66-96)
- `PaymentService.getOrCreateCurrentPayment()` (lines 319-369)

**Similarities:**
- Both calculate due date based on PaymentDueDay
- Both create Payment with MonthlyRent
- Both set default values (AmountPaid=0, RemainingBalance=Amount)

**Difference:**
- `createFirstPayment`: Uses move-in date
- `getOrCreateCurrentPayment`: Uses current date

**Impact:** Logic duplication, maintenance burden

---

## ‚úÖ What's Actually Good

### 1. PaymentService Dependencies Are Valid
- **tenantRepo/unitRepo needed**: PaymentService must fetch rent info when creating payments
- **Pattern**: Payment amount = `unit.MonthlyRent`, not stored in tenant
- **Solution**: This dependency is correct and necessary

### 2. Handler Separation is Clean
- RentalHandler: Owner operations
- TenantHandler: Tenant operations
- Clear separation of concerns

### 3. Repository Layer is Clean
- Each repository handles one entity
- Interfaces enable testing
- No cross-repository dependencies

---

## üéØ Restructuring Recommendations

Based on **actual code flow analysis**, here's what should be done:

### Priority 1: Fix TenantService (Critical)
**Problem:** Direct paymentRepo usage bypasses PaymentService
**Solution:** Inject PaymentService into TenantService

**Changes:**
```go
// Before
type TenantService struct {
    tenantRepo  interfaces.TenantRepository
    unitRepo    interfaces.UnitRepository
    paymentRepo interfaces.PaymentRepository  // ‚ùå Remove
}

// After
type TenantService struct {
    tenantRepo     interfaces.TenantRepository
    unitRepo       interfaces.UnitRepository
    paymentService *PaymentService  // ‚úÖ Add
}
```

**Impact:** 
- `createFirstPayment()` ‚Üí Use PaymentService method
- `MoveOutTenant()` ‚Üí Use PaymentService method
- Eliminates duplication
- Ensures consistency

---

### Priority 2: Fix VerifyTransaction Efficiency (High)
**Problem:** Loops all payments to find transaction
**Solution:** Query transaction first

**Add to PaymentRepository:**
```go
GetTransactionByID(transactionID string) (*PaymentTransaction, error)
```

**Refactor VerifyTransaction:**
```go
// Before: Loop all payments
payments, _ := s.paymentRepo.GetAllPayments()
for _, p := range payments { ... }

// After: Direct query
tx, err := s.paymentRepo.GetTransactionByID(transactionID)
paymentID = tx.PaymentID
```

---

### Priority 3: Extract Transaction Service (Optional)
**Problem:** PaymentService handles transactions + payments
**Benefit:** Clear separation, but adds complexity

**Decision:** 
- If splitting: Create PaymentTransactionService
- If keeping: Document that PaymentService handles both

**Recommendation:** Keep together for now (transactions tightly coupled to payments)

---

### Priority 4: Extract Status Service (Optional)
**Problem:** Status calculation mixed with data operations
**Benefit:** Reusable status logic

**Decision:** 
- Low priority - status methods are simple
- If splitting: Create PaymentStatusService
- Better alternative: Keep in PaymentService but group methods

---

## üìã Recommended Restructuring Plan

### Phase 1: Critical Fixes (DO FIRST) ‚úÖ

1. **Fix TenantService Dependencies**
   - Remove paymentRepo from TenantService
   - Inject PaymentService
   - Refactor `createFirstPayment()` to use PaymentService
   - Refactor `MoveOutTenant()` to use PaymentService

2. **Fix VerifyTransaction Efficiency**
   - Add `GetTransactionByID()` to PaymentRepository
   - Refactor `VerifyTransaction()` to use direct query

3. **Extract Payment Creation Helper**
   - Create shared method for payment creation
   - Used by both TenantService and PaymentService
   - Eliminates duplication

### Phase 2: Optional Improvements

4. **Extract PaymentTransactionService** (Optional)
   - Only if transaction logic grows complex
   - For now, transactions are simple enough to keep together

5. **Group PaymentService Methods** (Documentation)
   - Document method groupings
   - Add comments for each responsibility section

---

## üîó Dependency Flow After Restructuring

```
TenantService
  ‚îú‚îÄ> tenantRepo (direct)
  ‚îú‚îÄ> unitRepo (direct - for occupancy)
  ‚îî‚îÄ> paymentService (NEW) ‚Üê Uses PaymentService instead of paymentRepo
      ‚îÇ
      ‚îî‚îÄ> PaymentService
          ‚îú‚îÄ> paymentRepo (direct)
          ‚îú‚îÄ> tenantRepo (for rent info) ‚Üê Valid dependency
          ‚îî‚îÄ> unitRepo (for rent info) ‚Üê Valid dependency
```

---

## ‚úÖ Final Recommendation

**DO:**
1. ‚úÖ Fix TenantService to use PaymentService
2. ‚úÖ Fix VerifyTransaction inefficiency
3. ‚úÖ Extract shared payment creation helper

**DON'T Split Yet:**
- ‚ùå Don't split PaymentService yet (dependencies are valid)
- ‚ùå Don't create PaymentTransactionService yet (transactions are simple)
- ‚ùå Don't create PaymentStatusService yet (status logic is simple)

**REASONING:**
- PaymentService size (414 lines) is acceptable for Go services
- Dependencies (tenantRepo/unitRepo) are necessary and valid
- Transaction logic is simple (submit, verify, query)
- Splitting adds complexity without clear benefit
- Better to fix actual issues first (TenantService, efficiency)

---

## üéØ Clear Action Plan

**Step 1:** Fix TenantService (highest priority)
**Step 2:** Fix VerifyTransaction efficiency
**Step 3:** Extract shared payment helper
**Step 4:** Review if splitting is still needed after fixes

